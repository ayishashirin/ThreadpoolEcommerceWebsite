<!-- header -->
<%- include('../includes/adminSide/header') %>
  <!-- end of header -->

  <link rel="stylesheet" href="/adminSide/css/adminDashboard.css" />
  <link rel="stylesheet" href="/public/adminSide/sass/layout/_layout.scss" />

  <!-- CONTENT -->
  <section id="content">
    <!-- MAIN -->
    <main>


      <div class="head-title">
        <div class="left">
          <h1>Sales Report</h1>
          <ul class="breadcrumb">
            <li>
              <a href="#">Dashboard</a>
            </li>
            <li><i class="bx bx-chevron-right"></i></li>
            <li>
              <a class="active" href="#">Sales Report</a>
            </li>
          </ul>
        </div>
       
      </div>

      <div class="card mb-4">
        <header class="card-header">
          <h4 class="card-title">Latest orders</h4>
          <div class="row align-items-center">

           
            <div class=" d-flex flex-row w-50 ">
              <div class="custom_select ">

                <select class="form-select select-nice" name="reportType" id="reportType">
                  <option selected>
                    <%= currentType %>
                  </option>
                  <% reportTypes.forEach((reportType)=> { %>
                    <% if (reportType !==currentType) { %>
                      <option>
                        <%= reportType %>
                      </option>
                      <% } %>
                        <% }) %>
                </select>



                <div>
                  <button type="button" class="btn btn-success btn-fw mx-2 px-3 py-2"
                    onclick="generateReport()">Generate</button>
                </div>
              </div>
            </div>

        </header>
        <div class="card-body">
          <div class="table-responsive">
            <div class="table-responsive">
              <table class="table align-middle table-nowrap mb-0">
                <thead class="table-light">
                  <tr>

                    <th class="align-middle" scope="col">Number</th>
                    <th class="align-middle" scope="col">Orer Id</th>
                    <th class="align-middle" scope="col">Product Name</th>
                    <th class="align-middle" scope="col">Date</th>
                    <th class="align-middle" scope="col">Product Price</th>
                    <th class="align-middle" scope="col">Quantity</th>
                    <th class="align-middle" scope="col">Payment Method</th>
                    <th class="align-middle" scope="col">Total</th>
                  </tr>
                </thead>
                <tbody>

                  <% let count=0 %>
                    <% let totalAmount=0 %>
                      <% let discount=0 %>
                        <% if (sales && sales.length> 0) { %>
                          <% sales.forEach((sale)=> { %>

                            <% count++; %>
                              <% discount+=sale.discount; %>
                <tbody class="text-center">
                  <tr class="<%=count %2==0? 'bg-light' :''%>">
                    <td>
                      <%= count %>.
                    </td>
                    <td><a href="#" class="fw-bold">#<%= sale._id.toString().slice(0,6) %></a></td>
                    <td>
                      <%= sale.orderItems.pName %>
                    </td>
                    <td>
                      <%= sale.orderDate.toISOString().split('T')[0].split('-').reverse().join('-') %>
                    </td>
                    <td>
                      <%= (((sale.orderItems.lPrice * sale.orderItems.quantity) - (sale.orderItems.offerDiscountAmount +
                        sale.orderItems.couponDiscountAmount)) / sale.orderItems.quantity) %>
                    </td>
                    <td>
                      <%= sale.orderItems.quantity %>
                    </td>
                    <td><i class="material-icons md-payment font-xxl text-muted mr-5"></i>
                      <%= sale.paymentMethode %>
                    </td>
                    <td>
                      <%= ((sale.orderItems.quantity * sale.orderItems.lPrice) - (sale.orderItems.offerDiscountAmount +
                        sale.orderItems.couponDiscountAmount)) %>
                    </td>

                  </tr>
                  <% }); %>

                    <% } else { %>

                <tbody class="text-center">
                  <tr>
                    <td colspan="9">No sales found !
                    </td>
                  </tr>
                </tbody>

                <% } %>

                  <% if (sales && sales.length> 0) {
                    %>
                    <tr></tr>
                    <tr>
                      <td>
                        Subtotal:

                      </td>
                      <td class="" style="text-align: end;">

                        $<%=sales.reduce((sum,item)=>sum+=(item.orderItems.quantity*item.orderItems.lPrice),0) %>

                      </td>
                    </tr>

                    <tr>

                      <td>
                        Discount:

                      </td>
                      <td class="" style="text-align: end;">
                        -$ <%=sales.reduce((sum,item)=>sum+=item.orderItems.offerDiscountAmount,0)%>
                      </td>
                    </tr>
                    <tr>
                      <td class="font-weight-bold ">
                        Total:

                      </td>
                      <td class="font-weight-bold " style="text-align: end;">
                        $<%=(sales.reduce((sum,item)=>
                          sum+=(item.orderItems.quantity*item.orderItems.lPrice),0))-(sales.reduce((sum,item)=>sum+=item.orderItems.offerDiscountAmount,0))%>

                      </td>
                    </tr>

                    <% } %>



                      </tbody>
              </table>

              <% if (sales && sales.length> 0) { %>
                <div class="d-flex justify-content-end mt-4">
                  <button type="button" id="dwnld-exel-btn" class="btn btn-outline-dark  btn-icon-text p-1 mx-1"
                    onclick="">Exel
                    <i class="mdi mdi-printer btn-icon-append"></i></button>
                  <button type="button" id="dwnld-pdf-btn" class="btn btn-outline-dark  btn-icon-text p-1 mx-1">Pdf <i
                      class="mdi mdi-printer btn-icon-append"></i></button>



                </div>
                <% } %>
            </div>
          </div>
          <!-- table-responsive end// -->
        </div>
      </div>


    </main>
    <!-- MAIN -->
  </section>


  <!-- footer -->
  <%- include('../includes/adminSide/footer') %>
    <script>
      document.addEventListener('DOMContentLoaded', function () {

        const reportTypeSelect = document.getElementById('reportType');
        const dateFields = document.querySelector('.date-fields');

        // Event listener for select element
        reportTypeSelect.addEventListener('change', function () {
          if (this.value === 'Custom Date Range') {
            // Show the date fields
            dateFields.classList.remove('d-none');
            dateFields.classList.add('d-flex');

          } else {
            dateFields.classList.remove('d-flex');
            dateFields.classList.add('d-none');
          }
        });
      });


      function generateReport() {
        const reportType = document.getElementById('reportType').value;
        let queryParams = '';

        if (reportType === 'Custom Date Range') {
          const startDate = document.getElementById('startDate').value;
          const endDate = document.getElementById('endDate').value;
          queryParams = `?reportType=${reportType}&startDate=${startDate}&endDate=${endDate}`;
        } else {
          queryParams = `?reportType=${reportType}`;
        }

        window.location.href = `/adminSide/getSalesReport${queryParams}`
      }


      document.getElementById("dwnld-pdf-btn").addEventListener("click", function () {
        let doc = new window.jspdf.jsPDF();
        let pageCenter = doc.internal.pageSize.getWidth() / 2;
        const reportType = document.getElementById('reportType').value;
        // console.log(reportType)
        doc.setFontSize(25);
        doc.text("Threadpool", pageCenter, 10, {
          align: 'center'
        });
        doc.setFontSize(15);
        doc.text(`${reportType}'s Sales Report`, pageCenter, 20, {
          align: 'center'
        });

        let table = document.querySelector(".table");

        doc.autoTable({
          html: table,
          startY: 35
        });

        doc.save(`sales_report_${reportType}.pdf`);
      });

      document.getElementById("dwnld-exel-btn").addEventListener("click", function () {
        let workbook = XLSX.utils.book_new();

        let table = document.querySelector(".table");

        let worksheet = XLSX.utils.table_to_sheet(table);

        XLSX.utils.book_append_sheet(workbook, worksheet, "Sales Report");

        let range = XLSX.utils.decode_range(worksheet['!ref']);
        for (let C = range.s.c; C <= range.e.c; ++C) {
          let max_width = 0;
          for (let R = range.s.r; R <= range.e.r; ++R) {
            let cell_address = {
              c: C,
              r: R
            };
            let cell_ref = XLSX.utils.encode_cell(cell_address);
            if (!worksheet[cell_ref]) continue;
            let cell_width = XLSX.SSF.format(cell_address, worksheet[cell_ref].v).length;
            max_width = Math.max(max_width, cell_width);
          }
          worksheet['!cols'] = worksheet['!cols'] || [];
          worksheet['!cols'][C] = {
            wch: max_width + 1
          };
        }

        XLSX.writeFile(workbook, "sales_report.xlsx", {
          bookSST: true,
          type: 'binary'
        });
      });
    </script>

    <script src="/adminSide/js/adminDashboard.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.3/xlsx.full.min.js"></script>

    <!-- end of footer -->